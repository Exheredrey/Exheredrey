# Copyright 2012-2019 Timo Gurr <tgurr@exherbo.org>
# Distributed under the terms of the GNU General Public License v2

require github [ user=OpenPrinting release=release-${PV//./-} suffix=tar.xz ] \
    systemd-service [ systemd_files=[ "${WORK}"/utils/cups-browsed.service ] ] \
    autotools [ supported_autoconf=[ 2.5 ] supported_automake=[ 1.16 ] ]

SUMMARY="OpenPrinting CUPS filters"
DESCRIPTION="
This distribution contains backends, filters, and other software that was
once part of the core CUPS distribution but is no longer maintained by
Apple Inc. In addition it contains additional filters developed
independently of Apple, especially filters for the PDF-centric printing
workflow introduced by OpenPrinting.
"
HOMEPAGE+=" https://wiki.linuxfoundation.org/openprinting/${PN}"

LICENCES="GPL-2 GPL-3 MIT"
SLOT="0"
PLATFORMS="~amd64 ~x86"
MYOPTIONS="
    avahi
    dbus
    ldap
    tiff
    ( providers: ijg-jpeg jpeg-turbo ) [[ number-selected = exactly-one ]]
"

DEPENDENCIES="
    build:
        virtual/pkg-config
    build+run:
        app-text/ghostscript
        app-text/poppler[>=0.20.3-rc2][lcms]
        app-text/qpdf[>=8.3.0]
        dev-libs/glib:2[>=2.30.2]
        media-libs/fontconfig[>=2.0.0]
        media-libs/freetype:2
        media-libs/lcms2
        media-libs/libpng:=
        net-print/cups[>=2.2.2] [[ note = [ newer version for rastertopdf support ] ]]
        avahi? (
            net-dns/avahi
            net-print/cups[avahi]
        )
        dbus? ( sys-apps/dbus )
        ldap? ( net-directory/openldap )
        providers:ijg-jpeg? ( media-libs/jpeg:= )
        providers:jpeg-turbo? ( media-libs/libjpeg-turbo )
        tiff? ( media-libs/tiff )
        !app-text/ghostscript[<9.09] [[
            description = [ cups-filters now provides gstopxl and gstoraster ]
            resolution = upgrade-blocked-before
        ]]
        !net-print/foomatic-filters [[
            description = [ cups-filters now includes foomatic-filters ]
            resolution = uninstall-blocked-before
        ]]
    test:
        fonts/dejavu
    suggestion:
        net-print/foomatic-db [[ description = [ for non-PostScript printers ] ]]
"

DEFAULT_SRC_PREPARE_PATCHES=(
    "${FILES}"/49.patch
)

DEFAULT_SRC_COMPILE_PARAMS=( -j1 )

src_configure() {
    local myconf=(
        --enable-auto-setup-driverless
        --enable-driverless
        --enable-foomatic
        --enable-ghostscript
        --enable-gs-ps2write
        --enable-imagefilters
        --enable-pclm
        --enable-poppler
        --disable-braille
        --disable-mutool
        --disable-static
        --with-apple-raster-filter=rastertopdf
        --with-browseremoteprotocols="$(option avahi && echo 'dnssd ')$(option ldap && echo 'ldap ')cups"
        --with-cups-config=/usr/$(exhost --target)/bin/cups-config
        --with-cups-domainsocket=/run/cups/cups.sock
        --with-cups-rundir=/run/cups
        --with-fontdir=fonts/conf.avail
        --with-ippfind-path=system
        --with-jpeg
        --with-pdftops=hybrid
        --with-png
        --with-shell=/usr/$(exhost --target)/bin/bash
        --with-test-font-path=/usr/share/fonts/X11/dejavu/DejaVuSans.ttf
        --without-php
        --without-rcdir
        $(option_enable avahi)
        $(option_enable dbus)
        $(option_enable ldap)
        $(option_with tiff)
    )

    econf "${myconf[@]}"
}

src_install() {
    default

    install_systemd_files

    # adjust to CUPS upstream systemd unit file name
    edo sed -e 's:cups.service:org.cups.cupsd.service:g' \
            -i "${IMAGE}"/usr/$(exhost --target)/lib/systemd/system/cups-browsed.service

    if ! option avahi ; then
        edo sed -e 's: avahi-daemon.service::g' \
                -i "${IMAGE}"/usr/$(exhost --target)/lib/systemd/system/cups-browsed.service
    fi
}

